<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Decentralized Encrypted Storage</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.min.js"></script>
  <script src="https://unpkg.com/@lighthouse-web3/sdk/dist/lighthouse.min.js"></script>
  <style>
    body { font-family: Arial; padding: 2rem; background: #111; color: #eee; }
    input, button { margin: 0.4rem; padding: 0.4rem; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h2>üîê Polygon + Lighthouse Storage dApp</h2>
  <p>Connect wallet, choose file, and upload securely to IPFS/Filecoin.</p>

  <input type="file" id="fileInput" />
  <button id="connectBtn">ü¶ä Connect Wallet</button>
  <button id="uploadBtn">‚¨ÜÔ∏è Upload Encrypted</button>
  <br />
  <input type="text" id="cidInput" placeholder="Enter CID to download" />
  <button id="downloadBtn">‚¨áÔ∏è Download / Decrypt</button>
  <br />
  <input type="text" id="shareCid" placeholder="CID to share" />
  <input type="text" id="shareAddr" placeholder="Wallet to share with" />
  <button id="shareBtn">üë• Grant Access</button>
  <br />
  <input type="text" id="revokeCid" placeholder="CID to revoke" />
  <input type="text" id="revokeAddr" placeholder="Wallet to revoke" />
  <button id="revokeBtn">üö´ Revoke Access</button>
  <br />
  <input type="text" id="deleteCid" placeholder="CID to delete" />
  <button id="deleteBtn">üóëÔ∏è Delete</button>

  <script type="module">
    // ---------------- CONFIG ----------------
    const LIGHTHOUSE_API_KEY = "63582a6b0eefd5ecc0a44790b049e60f5645c30d";
    const CONTRACT_ADDRESS = "0x33e0ffe5340fe8Aacf11F2f1FB67A469E4607545";
    const FileRegistryABI = [
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"cid","type":"string"}],"name":"AccessGranted","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"cid","type":"string"}],"name":"AccessRevoked","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"string","name":"cid","type":"string"}],"name":"FileDeleted","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"string","name":"cid","type":"string"},{"indexed":false,"internalType":"string","name":"fileName","type":"string"}],"name":"FileUploaded","type":"event"},
      {"inputs":[{"internalType":"string","name":"cid","type":"string"}],"name":"deleteFile","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"string","name":"cid","type":"string"}],"name":"getFile","outputs":[{"components":[{"internalType":"string","name":"cid","type":"string"},{"internalType":"string","name":"fileName","type":"string"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"uploadTime","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"internalType":"struct FileRegistry.FileInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"cid","type":"string"}],"name":"grantAccess","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"cid","type":"string"}],"name":"hasAccess","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"cid","type":"string"}],"name":"revokeAccess","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"string","name":"cid","type":"string"},{"internalType":"string","name":"fileName","type":"string"}],"name":"uploadFile","outputs":[],"stateMutability":"nonpayable","type":"function"}
    ];

    let provider, signer, contract;

    // ---------------- WALLET ----------------
    async function connectWallet() {
      try {
        if (!window.ethereum) return alert("MetaMask not detected. Install MetaMask first.");
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, FileRegistryABI, signer);
        const addr = await signer.getAddress();
        alert(`Connected: ${addr}`);
      } catch(e) {
        console.error(e);
        alert("Failed to connect wallet.");
      }
    }
    document.getElementById("connectBtn").onclick = connectWallet;

    // ---------------- UPLOAD ----------------
    async function uploadEncrypted() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Select a file first.");
      const output = await lighthouse.uploadEncrypted(file, LIGHTHOUSE_API_KEY, p => {
        console.log(`Uploading: ${(p.uploaded / p.total * 100).toFixed(2)}%`);
      });
      const cid = output.data.Hash;
      console.log("Uploaded CID:", cid);
      const tx = await contract.uploadFile(cid, file.name);
      await tx.wait();
      alert(`‚úÖ Uploaded and encrypted!\nCID: ${cid}`);
    }
    document.getElementById("uploadBtn").onclick = uploadEncrypted;

    // ---------------- DOWNLOAD ----------------
    async function decryptDownload() {
      const cid = document.getElementById("cidInput").value;
      if (!cid) return alert("Enter a CID.");
      const has = await contract.hasAccess(await signer.getAddress(), cid);
      if (!has) return alert("No access to this file.");
      const fileResp = await lighthouse.decryptFile(cid, LIGHTHOUSE_API_KEY);
      const blob = new Blob([fileResp.data]);
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "decrypted_" + Date.now();
      link.click();
      alert("‚úÖ File decrypted and downloaded.");
    }
    document.getElementById("downloadBtn").onclick = decryptDownload;

    // ---------------- SHARE ----------------
    async function shareAccess() {
      const cid = document.getElementById("shareCid").value;
      const addr = document.getElementById("shareAddr").value;
      if(!cid || !addr) return alert("Enter CID and wallet address.");
      await contract.grantAccess(addr, cid);
      await lighthouse.shareFile(LIGHTHOUSE_API_KEY, cid, [addr]);
      alert(`‚úÖ Access granted to ${addr}`);
    }
    document.getElementById("shareBtn").onclick = shareAccess;

    // ---------------- REVOKE ----------------
    async function revokeAccess() {
      const cid = document.getElementById("revokeCid").value;
      const addr = document.getElementById("revokeAddr").value;
      if(!cid || !addr) return alert("Enter CID and wallet address.");
      await contract.revokeAccess(addr, cid);
      await lighthouse.revokeFileAccess(LIGHTHOUSE_API_KEY, cid, [addr]);
      alert(`üö´ Access revoked from ${addr}`);
    }
    document.getElementById("revokeBtn").onclick = revokeAccess;

    // ---------------- DELETE ----------------
    async function deleteFile() {
      const cid = document.getElementById("deleteCid").value;
      if(!cid) return alert("Enter CID to delete.");
      await contract.deleteFile(cid);
      await lighthouse.revokeFileAccess(LIGHTHOUSE_API_KEY, cid, []);
      alert(`üóëÔ∏è File ${cid} deleted and access revoked`);
    }
    document.getElementById("deleteBtn").onclick = deleteFile;

  </script>
</body>
</html>

